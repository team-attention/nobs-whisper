name: Sync to Private

on:
  push:
    branches: [main]

jobs:
  sync-to-private:
    # Only run on public repo, not on private
    if: github.repository == 'team-attention/nobs-whisper'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          path: public

      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: team-attention/nobs-whisper-dev
          token: ${{ secrets.REPO_SYNC_TOKEN }}
          path: private

      - name: Sync changes to private
        run: |
          cd private

          # Get commit info from public repo
          ORIGINAL_MSG=$(cd ../public && git log -1 --pretty=%B)
          ORIGINAL_AUTHOR=$(cd ../public && git log -1 --pretty="%an")
          ORIGINAL_EMAIL=$(cd ../public && git log -1 --pretty="%ae")

          git config user.name "$ORIGINAL_AUTHOR"
          git config user.email "$ORIGINAL_EMAIL"

          # Sync files from public to private (exclude private-only files)
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.spets' \
            --exclude='.siat' \
            --exclude='CLAUDE.md' \
            --exclude='.github/workflows/mirror-to-public.yml' \
            --exclude='.github/workflows/spets.yml' \
            --exclude='.github/ISSUE_TEMPLATE/spets-task.yml' \
            ../public/ ./

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to sync"
          else
            git commit -m "$ORIGINAL_MSG"
            git push
            echo "âœ… Successfully synced to private repo"
          fi
